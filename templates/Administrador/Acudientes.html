   <!DOCTYPE html>
   <html lang="es">
   <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Gesti√≥n Acudientes</title>
     <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
     <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
     <link rel="stylesheet" href="{{ url_for('static', filename='css/Acudientes.css') }}">
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
   </head>
   <body>
     <header class="d-flex align-items-center p-3 border-bottom w-100">
       <button class="btn btn-dark" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar">
         <i class="bi bi-list"></i>
       </button>
       <h2 class="titulo-header mx-4 mb-0">| COLEGIO FE Y ALEGRIA</h2>

       <!-- Notificaciones -->
       <div class="dropdown">
  <button
    class="position-relative"
    type="button"
    id="dropdownMenuButton"
    data-bs-toggle="dropdown"
    aria-expanded="false"
    style="border: none; background: transparent; padding: 0;"
  >
    <i class="bi bi-bell-fill" style="font-size: 1.25rem; margin-left:850px;"></i>
    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
          id="contadorMensajes" style="display:none">0</span>
  </button>
  <ul class="dropdown-menu dropdown-menu-end p-3" style="width: 320px;" aria-labelledby="dropdownMenuButton">
    <li class="text-center text-muted small">√öltimas notificaciones</li>
    <div id="notificacionesRecientes" class="mt-2" style="max-height: 200px; overflow-y: auto;">
      <p class="text-center small text-secondary mb-0">Sin notificaciones recientes</p>
    </div>
  </ul>
</div>

<script src="{{ url_for('static', filename='js/notificaciones.js') }}"></script>

       <!-- Usuario -->
       <div class="dropdown">
    <button class="btn btn-usuario dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
      <span class="bi bi-person-circle"></span>
    </button>
    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton" id="dropdownADMIN">
      <li><a class="dropdown-item" href="{{url_for('perfil')}}">Perfil</a></li>
      
      <li><a class="dropdown-item" href="{{url_for('Administrador.configuracion_academica')}}">Configuracion Academica</a></li>
      <li><a class="dropdown-item" href="{{url_for('Administrador.historialacademico')}}">Historial Academico</a></li>

    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="{{url_for('login')}}">Cerrar sesi√≥n</a></li>
    </ul>
  </div>
     </header>

   <!-- MENU -->
     <section class="bg-light">
     <div class="offcanvas offcanvas-start text-white" data-bs-backdrop="true" tabindex="-1" id="sidebar">
     <div class="offcanvas-header">
       <h5 class="offcanvas-title">MEN√ö</h5>
     </div>
     <div class="offcanvas1-body">
       <ul class="nav flex-column">
             <li class="nav-item"><a href="{{ url_for('Administrador.paginainicio') }}" class="nav-link text-white"><i class="bi bi-house-fill"></i> Inicio</a></li>
             
             <a class="nav-link text-white" data-bs-toggle="collapse" href="#submenuNotas"><i class="bi bi-caret-down-fill"></i> Notas</a>
             <div class="collapse" id="submenuNotas">
               <ul class="nav flex-column ms-3">
                 <li><a href="{{ url_for('Administrador.notas_consultar') }}" class="nav-link text-white"><i class="bi bi-list-stars"></i> Consultar Notas</a></li>
                 <li><a href="{{ url_for('Administrador.notas_registro') }}" class="nav-link text-white"><i class="bi bi-list-stars"></i> Registrar Notas</a></li>    
                <li><a href="{{ url_for('Administrador.calculo_promedio') }}" class="nav-link text-white"><i class="bi bi-list-stars"></i> Calculo de Promedio</a></li>
               </ul>
             </div>

             <li class="nav-item"><a href="{{ url_for('Administrador.observador') }}" class="nav-link text-white"><i class="bi bi-eye-fill"></i> Observador</a></li>
             <li class="nav-item"><a href="{{ url_for('Administrador.cursos') }}" class="nav-link text-white"><i class="bi bi-inboxes"></i> Cursos</a></li>

             <a class="nav-link text-white" data-bs-toggle="collapse" href="#submenuUsuarios">
               <i class="bi bi-caret-down-fill"></i> Gesti√≥n de Usuarios
             </a>
             <div class="collapse" id="submenuUsuarios">
               <ul class="nav flex-column ms-3">
                 <li><a href="{{ url_for('Administrador.profesores') }}" class="nav-link text-white"><i class="bi bi-person-fill-gear"></i> Profesores</a></li>
                 <li><a href="{{ url_for('Administrador.acudientes') }}" class="nav-link text-white"><i class="bi bi-person-fill"></i> Acudientes</a></li>
                 <li><a href="{{ url_for('Administrador.estudiantes') }}" class="nav-link text-white"><i class="bi bi-mortarboard-fill"></i> Estudiantes</a></li>
                 <li><a href="{{ url_for('Administrador.repitentes') }}" class="nav-link text-white"><i class="bi bi-person-dash"></i> Lista Estudiantes Repitentes</a></li>
                 <li><a href="{{ url_for('Administrador.registro') }}" class="nav-link text-white"><i class="bi bi-people-fill"></i> Registro Usuarios</a></li>
               </ul>
             </div>

             <li class="nav-item"><a href="{{ url_for('Administrador.asignaturas') }}" class="nav-link text-white"><i class="bi bi-journals"></i> Asignatura</a></li>
             <li class="nav-item"><a href="{{ url_for('Administrador.ver_horarios') }}" class="nav-link text-white"><i class="bi bi-globe-americas"></i> Horarios</a></li>
             
           </ul>
         </div>
       </div>
     </div>
   </section>

   <!-- Contenido principal -->

     <div class="container py-4">
  <h2 class="fw-bold text-center mb-4 "style="font-size: 2.5rem;">REGISTRO DE ACUDIENTES</h2>
      <p class="text-center text-muted mb-4">Por favor diligencie todos los campos para el registro de Acudientes</p>

  <!-- FORMULARIO REGISTRO ACUDIENTE -->
  <div class="card shadow-lg border-0 p-4 rounded-4 mb-5">

    <form id="formRegistrarAcudiente" novalidate>
      <h5 class="fw-bold mb-3">Datos B√°sicos</h5>

      <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Nombres:</label>
              <input type="text" class="form-control" name="Nombre" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Apellidos:</label>
              <input type="text" class="form-control" name="Apellido" required>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Tipo de Documento:</label>
              <select class="form-select" name="TipoDocumento" required>
                <option value="">Seleccione...</option>
                <option value="CC">CC</option>
                <option value="CE">CE</option>
                <option value="PA">PA</option>
                <option value="PPT">PPT</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">N√∫mero de Documento:</label>
              <input type="text" class="form-control" name="NumeroDocumento" required>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">G√©nero:</label>
              <select class="form-select" name="Genero" required>
                <option value="">Seleccione...</option>
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Tel√©fono:</label>
              <input type="text" class="form-control" name="Telefono" required>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Correo Electr√≥nico:</label>
              <input type="email" class="form-control" name="Correo" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Direcci√≥n:</label>
              <input type="text" class="form-control" name="Direccion" required>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Contrase√±a:</label>
              <input type="password" class="form-control" name="Contrasena" id="Contrasena" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Confirmar Contrase√±a:</label>
              <input type="password" class="form-control" name="ConfirmarContrasena" id="ConfirmarContrasena" required>
            </div>
          </div>

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary px-4">Registrar Acudiente</button>
        <button type="button" class="btn btn-success px-4" id="btnAbrirModal">Asignar Estudiante</button>
      </div>
    </form>
  </div>

  <!-- MODAL RELACI√ìN ACUDIENTE -->
  <div class="modal fade" id="modalRelacion" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content rounded-4 shadow">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Asignar Estudiante al Acudiente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <form id="formRelacion">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Acudiente:</label>
              <select name="ID_Usuario" class="form-select" required>
                {% for a in usuarios_acudientes %}
                  <option value="{{ a.ID_Usuario }}">{{ a.Nombre }} {{ a.Apellido }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Estudiante:</label>
              <select name="ID_Estudiante" class="form-select" required>
                {% for e in estudiantes %}
                <option value="{{ e.ID_Usuario }}">{{ e.Nombre }} {{ e.Apellido }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Parentesco:</label>
              <select name="Parentesco" class="form-select" required>
                <option value="">Seleccione...</option>
                <option value="Padre">Padre</option>
                <option value="Madre">Madre</option>
                <option value="Abuelo">Abuelo</option>
                <option value="Abuela">Abuela</option>
                <option value="Hermano">Hermano</option>
                <option value="Hermana">Hermana</option>
                <option value="T√≠o">T√≠o</option>
                <option value="T√≠a">T√≠a</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Estado:</label>
              <select name="Estado" class="form-select">
                <option value="Activo">Activo</option>
                <option value="Inactivo">Inactivo</option>
              </select>
            </div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Guardar Relaci√≥n</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
document.getElementById('formRegistrarAcudiente').addEventListener('submit', async function(e) {
  e.preventDefault();
  const form = e.target;
  const data = Object.fromEntries(new FormData(form).entries());

  const pass = data.Contrasena;
  const confirm = data.ConfirmarContrasena;

  if (pass !== confirm) {
    alert('‚ö†Ô∏è Las contrase√±as no coinciden.');
    return;
  }

  data.Rol = 'Acudiente';

  try {
    const res = await fetch("{{ url_for('Administrador.registrar_usuario_acudiente') }}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await res.json();
    if (res.ok) {
      alert('‚úÖ ' + result.message);

      // üëâ Guardar ID del acudiente reci√©n creado
      const nuevoId = result.id || result.ID_Usuario;
      if (!nuevoId) {
        console.error("No se recibi√≥ ID del backend");
        alert("‚ö†Ô∏è Error: el backend no retorn√≥ el ID del nuevo usuario.");
        return;
      }

      // üëâ Asignar el ID al campo oculto dentro del modal
      const selectAcudiente = document.querySelector('#formRelacion select[name="ID_Usuario"]');
      selectAcudiente.innerHTML = `<option value="${nuevoId}" selected>${data.Nombre} ${data.Apellido}</option>`;

      // üëâ Abrir autom√°ticamente el modal de relaci√≥n
      const modal = new bootstrap.Modal(document.getElementById('modalRelacion'));
      modal.show();

      // üëâ Limpiar el formulario principal
      form.reset();
    } else {
      alert('‚ùå ' + result.message);
    }
  } catch (err) {
    alert('‚ö†Ô∏è Error al conectar con el servidor.');
    console.error(err);
  }
});


document.getElementById('formRelacion').addEventListener('submit', async function(e) {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target).entries());

  // Verifica si el ID_Usuario viene vac√≠o
  if (!data.ID_Usuario || data.ID_Usuario === '') {
    const select = document.querySelector('#formRelacion select[name="ID_Usuario"]');
    data.ID_Usuario = select.value;
  }

  try {
    const res = await fetch("{{ url_for('Administrador.registrar_detalle_acudiente') }}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });

    const result = await res.json();
    if (res.ok) {
      alert('‚úÖ ' + result.message);
      bootstrap.Modal.getInstance(document.getElementById('modalRelacion')).hide();
      setTimeout(() => location.reload(), 800);
    } else {
      alert('‚ùå ' + result.message);
    }
  } catch (err) {
    alert('‚ö†Ô∏è Error de conexi√≥n con el servidor.');
    console.error(err);
  }
});

document.getElementById('btnAbrirModal').addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('modalRelacion'));
    modal.show();

    // Opcional: limpiar campos del modal
    document.getElementById('formRelacion').reset();

});
</script>
</body>
</html>