<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Observador</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Iconos -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- CSS propio -->
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/Observador.css') }}"
    />
  </head>
  <body>
    <!-- HEADER -->
    <header class="d-flex align-items-center p-3 border-bottom w-100">
      <button
        class="btn btn-dark"
        type="button"
        data-bs-toggle="offcanvas"
        data-bs-target="#sidebar"
        aria-controls="sidebar"
      >
        <i class="bi bi-list"></i>
      </button>
      <h2 class="titulo-header mx-4 mb-0">| COLEGIO FE Y ALEGRIA</h2>

      <div class="dropdown ms-auto me-3">
        <button
          class="btn btn-edunotas dropdown-toggle"
          type="button"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          <i class="bi bi-envelope-fill"></i>
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#">Ajustes</a></li>
          <li><a class="dropdown-item" href="#">Opción 2</a></li>
        </ul>
      </div>

      <div class="dropdown">
        <button
          class="btn btn-usuario dropdown-toggle"
          type="button"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          <i class="bi bi-person-lines-fill"></i>
        </button>
        <ul class="dropdown-menu">
          <li>
            <a class="dropdown-item" href="{{url_for('perfil')}}">Perfil</a>
          </li>
          <li>
            <a
              class="dropdown-item"
              href="{{url_for('Administrador.configuracion_academica')}}"
              >Configuración Académica</a
            >
          </li>
          <li>
            <a class="dropdown-item" href="{{url_for('login')}}"
              >Cerrar sesión</a
            >
          </li>
          <li>
            <a
              class="dropdown-item"
              href="{{url_for('Administrador.historialacademico')}}"
              >Historial Académico</a
            >
          </li>
        </ul>
      </div>
    </header>

    <!-- SIDEBAR -->
    <div
      class="offcanvas offcanvas-start text-white"
      data-bs-backdrop="true"
      tabindex="-1"
      id="sidebar"
    >
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">MENÚ</h5>
        <button
          type="button"
          class="btn-close text-reset"
          data-bs-dismiss="offcanvas"
          aria-label="Cerrar"
        ></button>
      </div>
      <div class="offcanvas-body">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a
              href="{{ url_for('Administrador.paginainicio') }}"
              class="nav-link text-white"
              ><i class="bi bi-house-fill"></i> Inicio</a
            >
          </li>

          <a
            class="nav-link text-white"
            data-bs-toggle="collapse"
            href="#submenuNotas"
            ><i class="bi bi-caret-down-fill"></i> Notas</a
          >
          <div class="collapse" id="submenuNotas">
            <ul class="nav flex-column ms-3">
              <li>
                <a
                  href="{{ url_for('Administrador.notas_consultar') }}"
                  class="nav-link text-white"
                  ><i class="bi bi-list-stars"></i> Consultar Notas</a
                >
              </li>
              <li>
                <a
                  href="{{ url_for('Administrador.notas_registro') }}"
                  class="nav-link text-white"
                  ><i class="bi bi-list-stars"></i> Registrar Notas</a
                >
              </li>
              <li>
                <a
                  href="{{ url_for('Administrador.calculo_promedio') }}"
                  class="nav-link text-white"
                  ><i class="bi bi-list-stars"></i> Cálculo de Promedio</a
                >
              </li>
            </ul>
          </div>

          <li class="nav-item">
            <a
              href="{{ url_for('Administrador.observador') }}"
              class="nav-link text-white"
              ><i class="bi bi-eye-fill"></i> Observador</a
            >
          </li>
          <li class="nav-item">
            <a
              href="{{ url_for('Administrador.cursos') }}"
              class="nav-link text-white"
              ><i class="bi bi-inboxes"></i> Cursos</a
            >
          </li>

          <a
            class="nav-link text-white"
            data-bs-toggle="collapse"
            href="#submenuUsuarios"
            ><i class="bi bi-caret-down-fill"></i> Gestión de Usuarios</a
          >
          <div class="collapse" id="submenuUsuarios">
            <ul class="nav flex-column ms-3">
              <li>
                <a
                  href="{{ url_for('Administrador.profesores') }}"
                  class="nav-link text-white"
                  ><i class="bi bi-person-fill-gear"></i> Profesores</a
                >
              </li>
              <li>
                <a
                  href="{{ url_for('Administrador.acudientes') }}"
                  class="nav-link text-white"
                  ><i class="bi bi-person-fill"></i> Acudientes</a
                >
              </li>
              <li>
                <a
                  href="{{ url_for('Administrador.estudiantes') }}"
                  class="nav-link text-white"
                  ><i class="bi bi-mortarboard-fill"></i> Estudiantes</a
                >
              </li>
              <li>
                <a
                  href="{{ url_for('Administrador.repitentes') }}"
                  class="nav-link text-white"
                  ><i class="bi bi-person-dash"></i> Lista Estudiantes
                  Repitentes</a
                >
              </li>
              <li>
                <a
                  href="{{ url_for('Administrador.registro') }}"
                  class="nav-link text-white"
                  ><i class="bi bi-people-fill"></i> Registro Usuarios</a
                >
              </li>
            </ul>
          </div>

          <li class="nav-item">
            <a
              href="{{ url_for('Administrador.asignaturas') }}"
              class="nav-link text-white"
              ><i class="bi bi-journals"></i> Asignatura</a
            >
          </li>
          <li class="nav-item">
            <a
              href="{{ url_for('Administrador.ver_horarios') }}"
              class="nav-link text-white"
              ><i class="bi bi-globe-americas"></i> Horarios</a
            >
          </li>
        </ul>
      </div>
    </div>

    <!-- MAIN -->
    <main class="container my-4">
      <div class="text-center mb-4">
        <h1 class="titulo-principal fw-bold">OBSERVADOR DE ESTUDIANTES</h1>
        <p class="descripcion text-muted">
          Gestiona las observaciones y control de cupos por grupo
        </p>
      </div>

      <div class="text-center mb-4">
        <button id="btnAbrirFormulario" class="btn btn-success">
          Agregar Observación
        </button>
      </div>

      <div class="table-responsive">
        <h4 class="text-azul fw-semibold mb-3">Observador de Estudiantes</h4>
        <table class="table table-hover text-center align-middle">
          <thead class="table-azul">
            <tr>
              <th>Nombre</th>
              <th>Tipo</th>
              <th>Nivel de Importancia</th>
              <th>Fecha</th>
              <th>Descripción</th>
              <th>Recomendación</th>
            </tr>
          </thead>
          <tbody id="tablaObservador">
            {% for obs, est in observaciones %}
            <tr>
              <td>{{ est.Nombre }} {{ est.Apellido }}</td>
              <td>{{ obs.Tipo }}</td>
              <td>{{ obs.NivelImportancia }}</td>
              <td>{{ obs.Fecha.strftime('%d/%m/%Y') if obs.Fecha else '' }}</td>
              <td class="text-start">
                <pre class="mb-0">{{ obs.Descripcion }}</pre>
              </td>
              <td class="text-start">
                <pre class="mb-0">{{ obs.Recomendacion }}</pre>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="6" class="text-muted">
                No hay observaciones registradas
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </main>

    <!-- MODAL CORREGIDO -->
<div class="modal fade" id="modalFormulario" tabindex="-1" aria-labelledby="modalFormularioLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-4">
      <div class="modal-header border-0">
          <h2 class="modal-title text-azul fw-bold">AGREGAR OBSERVACIÓN</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
      <div class="modal-body">
        <form id="formObservacion">

          <!-- SELECT DE ESTUDIANTES -->
          <select name="id_estudiante" class="form-control mb-2" required>
            <option value="" selected disabled>Seleccione un estudiante</option>
            {% for est in estudiantes %}
            <option value="{{ est.ID_Usuario }}">{{ est.Nombre }} {{ est.Apellido }}</option>
            {% endfor %}
          </select>

          <!-- (por ahora) horario fijo -->
          <input type="hidden" name="id_horario" value="1">

          <input type="text" name="tipo" placeholder="Tipo" required class="form-control mb-2">
          <input type="text" name="nivelImportancia" placeholder="Nivel de Importancia" required class="form-control mb-2">
          <input type="date" name="fecha" required class="form-control mb-2">
          <textarea name="descripcion" placeholder="Descripción" required class="form-control mb-2"></textarea>
          <textarea name="recomendacion" placeholder="Recomendación" required class="form-control mb-2"></textarea>

          <button type="submit" class="btn btn-success mt-2">Agregar</button>
        </form>
      </div>
    </div>
  </div>
</div>

    <!-- JS de Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JS de observador -->
    <script>
      document
        .getElementById("formObservacion")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const formData = new FormData(this);

          try {
            const response = await fetch(
              "/administrador/observador/registrar",
              {
                method: "POST",
                body: formData,
              }
            );
            const result = await response.json();
            console.log(result);
            alert(result.message || "Prueba completada");
            if (result.status === "ok") location.reload();
          } catch (error) {
            console.error(error);
            alert("Error al conectar con el servidor");
          }
        });

      // Abrir modal con botón
      document
        .getElementById("btnAbrirFormulario")
        .addEventListener("click", function () {
          const modal = new bootstrap.Modal(
            document.getElementById("modalFormulario")
          );
          modal.show();
        });
    </script>
    <script src="{{ url_for('static', filename='js/Administrador/observador.js') }}"></script>
  </body>
</html>
