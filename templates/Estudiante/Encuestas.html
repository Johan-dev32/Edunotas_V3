<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Colegio Fe y Alegría | Encuestas</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/Estudiante/encuestas.css') }}">
</head>

<body>
  <header class="d-flex align-items-center p-3 border-bottom w-100">
    <button class="btn btn-dark" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar">
      <i class="bi bi-list"></i>
    </button>
    <h2 class="titulo-header mx-4 mb-0">| COLEGIO FE Y ALEGRIA</h2>

    <div class="dropdown ms-auto">
      <button class="btn btn-edunotas position-relative dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
        <span class="bi bi-envelope-fill"></span>
      </button>
      <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton1">
        <li><a class="dropdown-item" href="#">Ajustes</a></li>
        <li><a class="dropdown-item" href="#">Opción 2</a></li>
        <li><a class="dropdown-item" href="#">Opción 3</a></li>
      </ul>
    </div>

    <div class="dropdown">
      <button class="btn btn-usuario dropdown-toggle" type="button" id="dropdownMenuButton2" data-bs-toggle="dropdown" aria-expanded="false">
        <span class="bi bi-person-lines-fill"></span>
      </button>
      <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton2">
        <li><a class="dropdown-item" href="{{url_for('perfil')}}">Perfil</a></li>
        <li><a class="dropdown-item" href="{{url_for('login')}}">Cerrar sesión</a></li>
      </ul>
    </div>
  </header>

  <section>
    <div class="offcanvas offcanvas-start text-white" data-bs-backdrop="true" tabindex="-1" id="sidebar">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">MENÚ</h5>
      </div>
      <div class="offcanvas1-body">
        <ul class="nav flex-column">
          <li class="nav-item"><a href="{{ url_for('Estudiante.paginainicio') }}" class="nav-link text-white"><i class="bi bi-house-fill"></i> Inicio</a></li>
          <li class="nav-item"><a href="{{ url_for('Estudiante.vernotas') }}" class="nav-link text-white"><i class="bi bi-journal-text"></i> Notas</a></li>
          <li class="nav-item"><a href="{{ url_for('Estudiante.MaterialDidactico') }}" class="nav-link text-white"><i class="bi bi-folder2-open"></i> Material Didáctico</a></li>
          <li class="nav-item"><a href="{{ url_for('Estudiante.observador') }}" class="nav-link text-white"><i class="bi bi-eye-fill"></i> Observador</a></li>
          <li class="nav-item"><a href="{{ url_for('Estudiante.verhorario') }}" class="nav-link text-white"><i class="bi bi-calendar2-range"></i> Ver Horario</a></li>
          <li class="nav-item"><a href="{{ url_for('Estudiante.tutorias') }}" class="nav-link text-white"><i class="bi bi-people-fill"></i> Tutorías</a></li>
          <li class="nav-item"><a href="{{ url_for('Estudiante.evaluaciones') }}" class="nav-link text-white"><i class="bi bi-journal-bookmark-fill"></i> Evaluaciones</a></li>
          <li class="nav-item"><a href="{{ url_for('Estudiante.noticias_vistas') }}" class="nav-link text-white"><i class="bi bi-newspaper"></i> Noticias</a></li>
          <li class="nav-item"><a href="{{ url_for('Estudiante.comunicacion') }}" class="nav-link text-white"><i class="bi bi-chat-dots menu-icon"></i> Comunicación</a></li>
          <li class="nav-item"><a href="{{ url_for('Estudiante.citaciones') }}" class="nav-link text-white"><i class="bi bi-person-video3"></i> Citaciones</a></li>
          <li class="nav-item"><a href="{{ url_for('Estudiante.encuestas_estudiante') }}" class="nav-link text-white active"><i class="bi bi-card-checklist"></i> Encuestas</a></li>
        </ul>
      </div>
    </div>
  </section>

  <div class="container mt-4">
    <h2 class="section-title mb-3">Encuestas</h2>
    <p class="info-text">A continuación, encontrará todas las encuestas activas dirigidas a su rol. Haga clic en una encuesta para responderla.</p>

    <div id="encuestas-container" class="row"></div>
  </div>

  <div class="modal fade" id="encuestaModal" tabindex="-1" aria-labelledby="encuestaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="encuestaModalLabel">Cargando Encuesta...</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modal-body-bs"></div>
        <div class="modal-footer"></div>
      </div>
    </div>
  </div>

  <script>
document.addEventListener("DOMContentLoaded", async () => {
    const contenedor = document.getElementById("encuestas-container");
    const modalElement = document.getElementById('encuestaModal');
    const modalBootstrap = new bootstrap.Modal(modalElement); 
    const modalBody = document.getElementById("modal-body-bs");
    const modalTitle = document.getElementById("encuestaModalLabel");
    let encuestaSeleccionada = null;

    async function cargarEncuestas() {
        try {
            const res = await fetch("/estudiante/api/encuestas");
            if (!res.ok) throw new Error("Error al cargar encuestas");
            const encuestas = await res.json();

            contenedor.innerHTML = "";

            if (encuestas.length === 0) {
                contenedor.innerHTML = `<div class="alert alert-info text-center">No hay encuestas disponibles.</div>`;
                return;
            }

            encuestas.forEach(encuesta => {
                const card = document.createElement("div");
                card.className = "card mb-3 shadow-sm";

                let estado = encuesta.vencida ? 
                    `<span class="badge bg-secondary">Vencida</span>` : 
                    encuesta.respondida ? 
                        `<span class="badge bg-success">Respondida</span>` : 
                        `<span class="badge bg-primary">Activa</span>`;

                const boton = (!encuesta.vencida && !encuesta.respondida) ? 
                    `<button class="btn btn-primary btn-responder" data-id="${encuesta.id}">Responder</button>` : "";

                card.innerHTML = `
                    <div class="card-body d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title mb-1">${encuesta.titulo}</h5>
                            <p class="mb-1 text-muted small">${encuesta.descripcion || ""}</p>
                            <p class="mb-0 text-muted small"><strong>Cierra:</strong> ${encuesta.fechaCierre || 'N/A'}</p>
                        </div>
                        <div class="text-end">
                            ${estado}<br>
                            ${boton}
                        </div>
                    </div>
                `;
                contenedor.appendChild(card);
            });

            document.querySelectorAll(".btn-responder").forEach(btn => {
                btn.addEventListener("click", e => abrirModal(e.target.dataset.id));
            });

        } catch (error) {
            console.error("Error al cargar encuestas:", error);
            contenedor.innerHTML = `<div class="alert alert-danger text-center">Error al cargar encuestas.</div>`;
        }
    }

    async function abrirModal(idEncuesta) {
        try {
            const res = await fetch(`/estudiante/api/encuestas/${idEncuesta}`);
            if (!res.ok) throw new Error("Error al cargar preguntas");

            encuestaSeleccionada = await res.json();
            modalTitle.textContent = encuestaSeleccionada.titulo;

            let formHTML = '';
            encuestaSeleccionada.preguntas.forEach(p => {
                formHTML += `
                    <div class="mb-3">
                        <label class="form-label"><strong>${p.texto}</strong></label>
                        <input type="text" class="form-control" name="preg_${p.ID_Pregunta}" placeholder="Tu respuesta..." required>
                    </div>
                `;
            });

            modalBody.innerHTML = `
                <p>${encuestaSeleccionada.descripcion || ""}</p>
                <hr>
                <form id="formEncuesta">
                    ${formHTML}
                    <div class="text-end mt-3">
                        <button type="submit" class="btn btn-primary">Enviar respuestas</button>
                    </div>
                </form>
            `;

            const form = modalBody.querySelector("#formEncuesta");
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const respuestas = {};
                encuestaSeleccionada.preguntas.forEach(p => {
                    const resp = formData.get(`preg_${p.ID_Pregunta}`);
                    if (resp && resp.trim()) respuestas[p.ID_Pregunta] = resp.trim();
                });

                if (Object.keys(respuestas).length === 0) {
                    alert("Debes responder al menos una pregunta.");
                    return;
                }

                try {
                    const btnEnviar = form.querySelector("button[type='submit']");
                    btnEnviar.disabled = true;
                    btnEnviar.textContent = "Enviando...";

                    const res = await fetch(`/estudiante/api/encuestas/${encuestaSeleccionada.id}/responder`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ respuestas }),
                    });

                    btnEnviar.disabled = false;
                    btnEnviar.textContent = "Enviar respuestas";

                    if (res.ok) {
                        alert("✅ Encuesta respondida correctamente");
                        modalBootstrap.hide();
                        cargarEncuestas();
                    } else {
                        const errorData = await res.json();
                        alert(`❌ Error: ${errorData.error || 'Intenta de nuevo.'}`);
                    }
                } catch (err) {
                    console.error(err);
                    alert("Error de conexión");
                }
            });

            modalBootstrap.show();

        } catch (err) {
            console.error(err);
            alert("Error al cargar la encuesta.");
        }
    }

    cargarEncuestas();
});
</script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
